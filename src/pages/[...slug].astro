---
import CMS from "src/store/CMS";
import Layout from "@layouts/Layout.astro";
import shouldDisplayExperimentals from "@utils/shouldDisplayExperimentals";

import Posts from "@pages/Posts.astro";
import BasicPage from "@pages/BasicPage.astro";
import BlogDetails from "@pages/BlogDetails.astro";
import HowToDetails from "@pages/HowToDetails.astro";
import Crowdfunding from "@pages/Crowdfunding.astro";
import CrowdfundingForm from "@pages/CrowdfundingForm.astro";

import DefaultRouteRedirect from "@scripts/DefaultRouteRedirect.astro";
import TranslationNotFoundRedirect from "@scripts/TranslationNotFoundRedirect.astro";

export async function getStaticPaths() {
  const {
    i18NLocales,
    recurringElement,
    blogs,
    howTos,
    crowdfundingForm,
    crowdfundingPlans,
    crowdfundingHome,
    basicPages: basicPagesData,
    crowdfundingPaymentConfirmation,
    homeBlog,
    homeHowTo,
    homepage,
  } = CMS.get("all");

  const allLocales = i18NLocales.data.map(({ attributes }) =>
    attributes.code.substring(0, 2)
  );

  const getRouteData = (page, getProps) => {
    const defaultSlug = page.attributes.Meta?.URL_slug,
      availableLocales = [
        "en",
        ...page.attributes.localizations.data.map(({ attributes }) =>
          attributes.locale.substring(0, 2)
        ),
      ];

    return [
      { defaultRoute: true },
      ...allLocales.map((locale) =>
        locale === "en"
          ? page.attributes
          : page.attributes.localizations.data.find(
              ({ attributes }) => attributes.locale.substring(0, 2) === locale
            )?.attributes || { locale, translationNotFound: true }
      ),
    ].map((attributes) => {
      const { locale } = attributes,
        { slug = attributes.Meta?.URL_slug || defaultSlug, ...props } = getProps
          ? getProps(page, attributes)
          : {},
        fullSlug =
          slug === "/"
            ? locale?.substring(0, 2)
            : locale
            ? locale?.substring(0, 2) + "/" + slug
            : slug;

      return {
        params: { slug: fullSlug },
        props: {
          page: {
            ...props,
            ...attributes,
            availableLocales,
          },
          recurData: recurringElement.data.attributes,
        },
      };
    });
  };

  const getPages = ({ data }, getProps) =>
    Array.isArray(data)
      ? data.map((page) => getRouteData(page, getProps)).flat()
      : getRouteData(data, getProps);

  const getPosts = ({ data }, locale) =>
    data
      .map(({ attributes }) => [
        attributes,
        attributes.localizations.data.map(({ attributes }) => attributes),
      ])
      .flat(2)
      .filter(
        (attributes) =>
          attributes.locale.substring(0, 2) === locale.substring(0, 2)
      )
      // @ts-ignore
      .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

  const plansPages = getPages(crowdfundingPlans, (page, { Title }) => ({
      type: "plan",
      Meta: crowdfundingForm.data.attributes.Meta,
      slug: `plans/${(Title || page.attributes.Title).toLowerCase()}`,
    })),
    crowdfundingPages = getPages(crowdfundingHome, () => ({
      type: "crowdfunding",
      allPlans: crowdfundingPlans.data.map(({ attributes }) => attributes),
    })),
    basicPages = getPages(basicPagesData, () => ({ type: "basic" })),
    crowdfundingPaymentConfirmationPages = getPages(
      crowdfundingPaymentConfirmation,
      () => ({ type: "basic" })
    ),
    blogDetailsPages = getPages(blogs, (page, attributes) => ({
      type: "blogDetails",
      blogs: attributes.locale && getPosts(blogs, attributes.locale),
    })),
    howToDetailsPages = getPages(howTos, (page, { locale }) => ({
      type: "howToDetails",
      howTos: locale && getPosts(howTos, locale),
    })),
    blogPages = getPages(homeBlog, (page, { locale }) => ({
      type: "blog",
      posts: locale && getPosts(blogs, locale),
    })),
    howToPages = getPages(homeHowTo, (page, { locale }) => ({
      type: "howTo",
      posts: locale && getPosts(howTos, locale),
    })),
    homepagePages = getPages(homepage, (page, { locale }) => ({
      type: "homepage",
      posts:
        locale &&
        (!shouldDisplayExperimentals()
          ? blogs
          : [...getPosts(blogs, locale), ...getPosts(howTos, locale)]),
    }));

  return [
    ...plansPages,
    ...crowdfundingPages,
    ...basicPages,
    ...crowdfundingPaymentConfirmationPages,
    ...blogDetailsPages,
    ...howToDetailsPages,
    ...blogPages,
    ...howToPages,
    ...homepagePages,
  ];
}

const { defaultRoute, translationNotFound } = Astro.props.page,
  isRedirectionNecessary = defaultRoute || translationNotFound;
---

{
  isRedirectionNecessary ? (
    <Fragment>
      {defaultRoute ? (
        <DefaultRouteRedirect />
      ) : (
        <TranslationNotFoundRedirect />
      )}
    </Fragment>
  ) : (
    () => {
      const { page } = Astro.props,
        locale = page.locale.substring(0, 2),
        { Meta: meta, availableLocales } = page,
        recurData =
          locale === "en"
            ? Astro.props.recurData
            : Astro.props.recurData.localizations.data.find(
                ({ attributes }) => attributes.locale.substring(0, 2) === locale
              ).attributes;

      return (
        <Layout
          locale={locale}
          availableLocales={availableLocales}
          meta={meta}
          recurData={recurData}
          metaImage={
            page.Intro_blob?.data?.attributes.provider_metadata.public_id ||
            page.Block_blob?.data?.attributes.provider_metadata.public_id ||
            recurData.OpenGraph_default?.data?.attributes.provider_metadata
              .public_id
          }
        >
          {page.type == `homepage` ? (
            <Posts page={page} />
          ) : page.type == `crowdfunding` ? (
            <Crowdfunding page={page} />
          ) : page.type == `basic` ? (
            <BasicPage page={page} />
          ) : page.type == `blog` ? (
            <Posts page={page} />
          ) : page.type == `blogDetails` ? (
            <BlogDetails page={page} recurData={recurData} />
          ) : page.type == `howTo` ? (
            <Posts page={page} />
          ) : page.type == `howToDetails` ? (
            <HowToDetails page={page} recurData={recurData} />
          ) : (
            <CrowdfundingForm page={page} locale={locale} />
          )}
        </Layout>
      );
    }
  )
}
