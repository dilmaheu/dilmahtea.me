---
import CMS from "@store/CMS";
import Layout from "@layouts/Layout.astro";
import BasicPage from "@pages/BasicPage.astro";
import SetPreferredLocale from "@scripts/SetPreferredLocale.astro";

// fetching the error page
const basicPagesData = CMS.get("basicPages");

let recurringElements = CMS.get("recurringElement").data.attributes,
  { attributes: _404Page } = basicPagesData.data.find(
    ({ attributes }) => attributes.Meta.URL_slug === "404"
  );

// saving it's page attributes like meta and other components
const requestPath = Astro.url.pathname;

const availableLocales = [
  "en",
  ..._404Page.localizations.data.map(({ attributes }) =>
    attributes.locale.substring(0, 2)
  ),
];

let [, locale] = requestPath.match(/^\/([a-z]{2})\//) ?? [];

if (!(locale && availableLocales.includes(locale))) locale = "en";

if (locale !== "en") {
  _404Page = _404Page.localizations.data.find(
    ({ attributes }) => attributes.locale.substring(0, 2) === locale
  ).attributes;

  recurringElements = {
    // localize recurring elements
    ...recurringElements.localizations.data.find(
      ({ attributes }) => attributes.locale.substring(0, 2) === locale
    ).attributes,
  };
}
---

<SetPreferredLocale />

<script is:inline define:vars={{ availableLocales }}>
  const localeRegex = new RegExp(
    `^/(${availableLocales.map((locale) => locale).join("|")})/`
  );

  let [, locale] = location.pathname.match(localeRegex) ?? [];

  if (
    !locale &&
    /* preferredLocale is defined in SetPreferredLocale.astro */
    preferredLocale !== "en"
  ) {
    location.pathname = location.pathname.replace("/", `/${preferredLocale}/`);
  }
</script>

<Layout
  locale={locale}
  availableLocales={availableLocales}
  meta={_404Page.Meta}
  recurData={recurringElements}
  metaImageID={_404Page.Block_blob?.data?.attributes.provider_metadata
    .public_id ||
    recurringElements.OpenGraph_default.data.attributes.provider_metadata
      .public_id}
>
  <BasicPage page={_404Page} />
</Layout>
