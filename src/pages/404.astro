---
import Layout from "../layouts/Layout.astro";

// getting the graphql query for fetch api
import AllPagesQuery from "../queries/AllPagesQuery";

// getting the Eror component
import Error from "../components/Error.astro";

// fetching the error page
const errorDefaultPage = await fetch(`${import.meta.env.DB_URL}`, {
  method: "POST",
  headers: {
    "Content-Type": "application/json",
    Authorization: `Bearer ${import.meta.env.ACCESS_TOKEN}`,
  },
  body: JSON.stringify({
    query: AllPagesQuery,
  }),
}).then((response) => response.json());

// saving it's page attributes like meta and other components
const error = errorDefaultPage.data.basicPages.data
const errorPage = error.filter((val) => val.attributes.Meta.URL_slug == "404")

const page = errorPage[0].attributes,
  locale = page.locale.substring(0, 2)

const availableLocales = page.localizations.data.map((localized) =>
  localized.attributes.locale.substring(0, 2)
);

// saving footer text
const recurData = errorDefaultPage.data.recurringElement.data.attributes;
---

<Layout locale={locale} availableLocales={availableLocales} meta={page.Meta} recurData={recurData}
  metaImage={page.Block_blob != null && (page.Block_blob.data != null) ? page.Block_blob.data.attributes.provider_metadata.public_id 
    : recurData.OpenGraph_default.data.attributes.provider_metadata.public_id}>
  <Error page={page} />
</Layout>