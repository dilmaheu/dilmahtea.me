---
import Markdown from "@astrojs/markdown-component";
import { Picture, BackgroundPicture } from "astro-imagetools/components";

import CMS from "@store/CMS";
import RecurringImages from "@store/RecurringImages";

import BaseLayout from "@layouts/BaseLayout.astro";

import Navbar from "@components/Navbar.astro";
import Footer from "@components/Footer.astro";
import CartOverlay from "@components/CartOverlay.astro";
import ClipPathSVG from "@components/ClipPathSVG.astro";
import UpdateTopMargin from "@scripts/UpdateTopMargin.astro";

interface Props {
  page: Record<string, any>;
  meta: Record<string, any>;
  locale: string;
  recurData: Record<string, any>;
  metaImageSrc: string;
  alternateURLs: { [locale: string]: string };
  availableLocales: string[];
}

const { green_cup } = RecurringImages;

const {
  page,
  meta,
  locale,
  recurData,
  alternateURLs,
  availableLocales,
  metaImageSrc,
} = Astro.props;

const footerText = recurData.Footer_text.replaceAll(
  "<current_year>",
  `${new Date().getFullYear()}`,
);

const { data: checkoutKindnessData } = CMS.get("checkoutKindness"),
  { ASSETS_URL } = import.meta.env;

const EnvironmentalAdvocacyImage =
  checkoutKindnessData.attributes.kindness_causes.data.find(
    ({ attributes: { cause } }) => cause === "Environmental Advocacy",
  ).attributes.featured_blob.data.attributes;

const { Nav_menu: menu } = recurData;

const bestWayToMakeCompostLink = CMS.get("howTos", locale)[0].attributes.Meta
  .URL_slug;
---

<style lang="scss">
  @use "src/styles/poly-fluid" as *;

  .hero {
    @include poly-fluid-sizing(
      "padding-top",
      (
        639.98px: 135px,
        640px: 70px,
        768px: 74px,
        1024px: 104px,
      )
    );
  }

  .nav-menu-container {
    nav {
      @include poly-fluid-sizing(
        "padding-right",
        (
          639px: 0px,
          640px: 260px,
          768px: 300px,
          1024px: 380px,
          1440px: 460px,
          1536px: 550px,
        )
      );

      a {
        @apply font-bold leading-[150%];

        font-size: poly-fluid-clamp(
          (
            768px: 12px,
            1440px: 18px,
          )
        );
      }
    }
  }

  :global(#checkout-cart-container) {
    > div {
      padding-bottom: poly-fluid-clamp(
        (
          375px: 20px,
          1440px: 56px,
        )
      );

      @include poly-fluid-sizing(
        "padding-top",
        (
          639px: 90px,
          640px: 95px,
          768px: 100px,
          960px: 110px,
          1024px: 120px,
          1280px: 130px,
          1536px: 145px,
          2050px: 165px,
        )
      );
    }
  }

  h1 {
    @apply leading-[115%] md:tracking-[-0.02em];

    font-size: poly-fluid-clamp(
      (
        375px: 32px,
        1440px: 48px,
      )
    );
  }

  .hero-icon {
    width: poly-fluid-clamp(
      (
        375px: 48px,
        1440px: 100px,
      )
    );

    height: poly-fluid-clamp(
      (
        375px: 48px,
        1440px: 100px,
      )
    );
  }

  .post-container {
    > div:first-child {
      clip-path: url(#post-container-top-curve);

      @media (min-width: 640px) {
        clip-path: url(#post-container-left-curve);
      }
    }

    > div:last-child {
      clip-path: url(#post-container-bottom-curve);

      @media (min-width: 640px) {
        clip-path: url(#post-container-right-curve);
      }
    }
  }

  .linked-post-text {
    font-size: poly-fluid-clamp(
      (
        375px: 18px,
        1440px: 24px,
      )
    );
  }
</style>

<ClipPathSVG
  id="post-container-top-curve"
  path="M0.513,0.005 C0.359,0.005,0.102,-0.024,0.043,0.141 C-0.003,0.266,-0.005,0.637,0.005,1 h0.985 c0.005,-0.205,0.027,-0.443,-0.018,-0.74 C0.924,-0.057,0.729,0.004,0.513,0.004"
/>

<ClipPathSVG
  id="post-container-bottom-curve"
  path="M1,0 H0 v0.41 c0,0.698,0.081,0.583,0.526,0.583 S1,1,1,0.37 c0,-0.083,-0.003,-0.21,0,-0.37"
/>

<ClipPathSVG
  id="post-container-left-curve"
  path="M0.005,0.487 c0,0.155,-0.028,0.411,0.137,0.471 c0.125,0.046,0.495,0.047,0.859,0.038 V0.009 C0.795,0.005,0.557,-0.017,0.26,0.028 C-0.057,0.076,0.005,0.271,0.005,0.486"
/>

<ClipPathSVG
  id="post-container-right-curve"
  path="M0,0 v1 h0.428 c0.676,0,0.565,-0.064,0.565,-0.526 S1,0,0.39,0 C0.31,0,0.155,0.003,0,0"
/>

<BaseLayout
  page={page}
  meta={meta}
  locale={locale}
  alternateURLs={alternateURLs}
  metaImageSrc={metaImageSrc}
>
  <div class="flex flex-wrap w-full h-full">
    <div class="block w-full bg-secondary">
      <Navbar
        docLocale={locale}
        footerText={footerText}
        availableLocales={availableLocales}
      />
      <div class="hero overflow-hidden relativ w-full">
        <UpdateTopMargin />

        <div class="relative">
          <div class="hidden md:flex items-end bg-primary-light md:h-[76px]">
            <div
              class="relative hidden md:flex items-end bg-dark-green md:h-[76px] w-full"
            >
              <div class="nav-menu-container wrapper pb-2.5 md:pb-[15px]">
                <nav class="text-white font-semibold h-full">
                  <span class="flex gap-5 justify-between items-center h-full">
                    {
                      menu.map(
                        ({ Visibility, Title, Link }) =>
                          Visibility && <a href={Link}>{Title}</a>,
                      )
                    }
                  </span>
                </nav>
              </div>
            </div>
          </div>
        </div>

        <div class="wrapper flex flex-col gap-[30px] items-center py-[50px]">
          <div class="flex flex-col gap-5 items-center text-center">
            <img class="hero-icon" {...green_cup} />

            <h1 class="recoleta font-semibold text-primary">{page.Title}</h1>

            <div class="prose"><Markdown>{page.Intro_text}</Markdown></div>
          </div>

          {
            (page.text_here_is_how || page.text_here_is_how) && (
              <div class="post-container max-w-4xl flex flex-col sm:flex-row">
                <div class="w-full sm:w-[37.5%] h-48 sm:h-auto">
                  <Picture
                    layout="fill"
                    sizes="(min-width: 640px) calc(min(896px, 90vw) * 0.375), 90vw"
                    alt={EnvironmentalAdvocacyImage.alternativeText}
                    src={ASSETS_URL + EnvironmentalAdvocacyImage.url}
                  />
                </div>

                <div class="flex flex-col gap-8 sm:gap-9 px-[22px] sm:px-8 pt-6 pb-9 sm:pb-5 bg-white">
                  {page.linked_post_text && (
                    <div class="prose linked-post-text font-medium">
                      <Markdown>{page.linked_post_text}</Markdown>
                    </div>
                  )}

                  {page.text_here_is_how && (
                    <a
                      href={bestWayToMakeCompostLink}
                      class:list={[
                        "w-fit px-16 py-4 sm:px-18 sm:py-[18px]",
                        "font-bold leading-[115%] text-white bg-primary rounded-full",
                      ]}
                    >
                      {page.text_here_is_how}
                    </a>
                  )}
                </div>
              </div>
            )
          }
        </div>
      </div>
    </div>

    <Footer footerText={footerText} recurData={recurData} />
  </div>

  <CartOverlay page={page} />
</BaseLayout>
