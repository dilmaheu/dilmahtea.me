---
import { Picture } from "astro-imagetools/components";

import CMS from "@store/CMS";
import Markdown from "@components/Markdown.astro";
import ClipPathSVG from "@components/ClipPathSVG.astro";

import CheckoutKindnessScript from "@solid/CheckoutKindnessScript";

const { page, recurData } = Astro.props,
  { locale } = page,
  { STRAPI_URL } = import.meta.env,
  checkoutRecurData = CMS.get("checkoutRecurringElement", locale);

const checkoutSuccessLink = `/${locale}/${
    CMS.get("checkoutSuccess", locale).Meta.URL_slug
  }/`,
  checkoutShippingLink = `/${locale}/${
    CMS.get("checkoutShipping", locale).Meta.URL_slug
  }/`,
  shopLink = `/${locale}/${CMS.get("homeProduct", locale).Meta.URL_slug}/`;
---

<style lang="scss">
  @use "src/styles/poly-fluid" as *;

  .kindness-header {
    h1 {
      @apply font-bold;

      font-size: poly-fluid-clamp(
        (
          375px: 28px,
          1440px: 48px,
        )
      );
    }

    .intro-text {
      font-size: poly-fluid-clamp(
        (
          375px: 16px,
          1440px: 18px,
        )
      );
    }
  }

  .kindness-causes {
    > .active-kindness-cause {
      @apply -m-3 p-1.5 bg-primary;

      clip-path: url(#kindness-cause-card-curve);

      > div {
        @apply p-1.5 bg-secondary;

        clip-path: url(#kindness-cause-card-curve);
      }
    }

    h2 {
      @apply sm:font-bold leading-[130%];

      font-size: poly-fluid-clamp(
        (
          375px: 24px,
          1440px: 28px,
        )
      );
    }
  }

  #submit-cause-btn:disabled {
    @apply bg-slate text-secondary;
  }
</style>

<script define:vars={{ checkoutShippingLink, shopLink }}>
  const { paymentID } = Object.fromEntries(
    new URLSearchParams(location.search),
  );

  if (!paymentID) {
    const cartLength = Object.keys(window.cart).length;

    location.href = cartLength === 0 ? shopLink : checkoutShippingLink;
  }

  window.paymentID = paymentID;
</script>

<ClipPathSVG
  id="kindness-cause-card-curve"
  path="M0.99,0.554 V0.735 c0,0.331,-0.079,0.243,-0.519,0.258 S0.004,1,0.004,0.718 c0,-0.037,0.004,-0.093,0.001,-0.164 C-0.005,0.353,-0.003,0.148,0.042,0.078 C0.102,-0.013,0.358,0.003,0.513,0.003 c0.216,0,0.41,-0.034,0.459,0.141 C1,0.309,0.995,0.441,0.99,0.554"
/>

<div class="wrapper pt-6 pb-12 flex flex-col gap-12">
  <section class="kindness-header text-center text-primary">
    <h1 class="recoleta tracking-[-0.02em]">{page.Title}</h1>

    <div class="intro-text"><Markdown>{page.Intro_text}</Markdown></div>
  </section>

  <section
    role="list"
    aria-label={checkoutRecurData.Aria_label_kindness_cause_items_text}
    class="kindness-causes flex flex-col sm:flex-row flex-wrap justify-center gap-10"
  >
    {
      page.kindness_causes.data.map(
        ({
          attributes: { cause, description, featured_blob, localizations },
        }) => (
          <div
            tabindex="0"
            role="listitem"
            aria-label={cause}
            class="kindness-cause"
            data-cause={localizations?.data[0]?.attributes?.cause || cause}
          >
            <div class="h-full">
              <div
                style="clip-path: url(#kindness-cause-card-curve);"
                class="relative w-full h-full sm:w-80 flex flex-col bg-primary cursor-pointer"
              >
                <div class="h-48">
                  <Picture
                    layout="fill"
                    sizes="(min-width: 640px) 320px, 90vw"
                    alt={featured_blob.data.attributes.alternativeText}
                    src={STRAPI_URL + featured_blob.data.attributes.url}
                  />
                </div>

                <div class="grow px-6 pt-5 pb-7 flex flex-col justify-center gap-2">
                  <h2 class="recoleta text-white leading-[120%]">{cause}</h2>

                  <div class="font-medium text-base text-white">
                    <Markdown>{description}</Markdown>
                  </div>
                </div>
              </div>
            </div>
          </div>
        ),
      )
    }
  </section>

  <div
    class:list={[
      "flex flex-col-reverse sm:flex-row items-center",
      "justify-center sm:justify-start gap-9 sm:gap-12 mx-auto",
    ]}
  >
    <a href={checkoutSuccessLink} class="text-primary font-bold">
      {recurData.text_skip}
    </a>

    <button
      disabled
      id="submit-cause-btn"
      class:list={[
        "w-full sm:w-auto py-4 px-20 sm:px-24",
        "bg-primary text-white font-bold rounded-full",
      ]}
    >
      {page.text_submit_kindness_cause}
    </button>
  </div>
</div>

<CheckoutKindnessScript client:only checkoutSuccessLink={checkoutSuccessLink} />
