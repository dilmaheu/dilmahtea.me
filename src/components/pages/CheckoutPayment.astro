---
import CMS from "@store/CMS";
import Markdown from "@components/Markdown.astro";
import DynamicHTML from "@components/DynamicHTML.astro";
import OrderSummary from "@components/OrderSummary.astro";
import shouldDisplayExperimentals from "@utils/shouldDisplayExperimentals";

import localizeCMSImage from "@utils/localizeCMSImage";

const { page, recurData } = Astro.props,
  { locale, payment_methods, Accepted_cards_icon } = page,
  checkoutFlowData = CMS.get("checkoutFlow").data.attributes,
  steps = checkoutFlowData.steps.split("\n"),
  shortenedSteps = checkoutFlowData.shortened_steps.split("\n"),
  checkoutCartLink = CMS.get("cart", locale).Meta.URL_slug,
  checkoutShippingLink = CMS.get("checkoutShipping", locale).Meta.URL_slug,
  checkoutInfo = CMS.get("checkoutInformation", locale),
  checkoutInfoLink = `/${locale}/${checkoutInfo.Meta.URL_slug}/`,
  checkoutKindnessLink = `/${locale}/${
    CMS.get("checkoutKindness", locale).Meta.URL_slug
  }/`,
  userRecurr = CMS.get("userAccountRecurringElement", locale);

const methods = payment_methods.data?.map(({ attributes }) => attributes),
  accepted_cards_icon = Accepted_cards_icon.data?.map(
    ({ attributes }) => attributes,
  ),
  isIdeal = methods.map(({ method }) =>
    method?.toLowerCase()?.includes("ideal"),
  );
---

<style lang="scss">
  @use "src/styles/checkout" as *;
</style>

<script
  define:vars={{
    checkoutInfoLink,
    checkoutKindnessLink,
  }}
>
  if (Object.keys(window.checkoutInfo).length === 0) {
    location.href = checkoutInfoLink;
  }

  window.checkoutKindnessLink = checkoutKindnessLink;
</script>

<form
  method="POST"
  id="payment-info-form"
  class="section-gap grid w-full xl:w-2/3"
  action={checkoutKindnessLink}
>
  <!-- action={shouldDisplayExperimentals
      ? "https://dev.pay.scripts.dilmahtea.me"
      : "https://pay.scripts.dilmahtea.me"} -->
  <DynamicHTML
    htmlFn={() => {
      const { origin, pathname } = location;

      const product_desc = Object.keys(window.cart)
        .map((id) => {
          const productData = window.cart[id],
            names = JSON.parse(productData.names),
            name = names[window.preferredLocale] || names["en"];

          return `${productData.quantity}x ${name}`;
        })
        .join(", ");

      const paymentInfo = {
        ...window.checkoutInfo,
        product_desc,
        cart: JSON.stringify(window.cart),
        tax: window.cart.tax.split(",").join("."),
        price: window.cart.total.split(",").join("."),
        payment_type: "ecommerce",
        locale: window.preferredLocale,
        origin_url: origin + pathname,
        success_url: `${origin}${window.checkoutKindnessLink}?clear=cart`,
      };

      // delete paymentInfo.delivery_address;

      return Object.keys(paymentInfo)
        .map(
          (name) =>
            `<input type="hidden" name="${name}" value='${paymentInfo[name]}' />`,
        )
        .join("");
    }}
  />

  <section
    role="list"
    aria-label={userRecurr.Input_label_email}
    class="tiled-div-pad division-in-gap grid bg-secondary-light rounded-[10px]"
  >
    <div
      role="listitem"
      aria-label={page.Aria_label_email_address_text}
      class="division-in-element-gap"
    >
      <div class="input-label text-black">
        {userRecurr.Input_label_email}
      </div>

      <div class="division-in-element-gap flex flex-wrap items-center">
        <div class="input-text-large-static grow">
          <DynamicHTML htmlFn={() => window.checkoutInfo.email} />
        </div>

        <a
          aria-label={`${userRecurr.Button_change_text} ${userRecurr.Input_label_email}`}
          href={checkoutInfoLink + "?change=email"}
          class="button-link-large"
        >
          {userRecurr.Button_change_text}
        </a>
      </div>
    </div>

    <div class="w-full h-px bg-primary-light"></div>

    <div
      role="listitem"
      aria-label={page.Aria_label_email_address_text}
      class="division-in-element-gap"
    >
      <div class="input-label text-black">
        {userRecurr.Label_delivery_address}
      </div>

      <div class="division-in-element-gap flex flex-wrap items-center">
        <div class="input-text-large-static grow">
          <DynamicHTML htmlFn={() => window.checkoutInfo.delivery_address} />
        </div>

        <a
          aria-label={`${userRecurr.Button_change_text} ${userRecurr.Label_delivery_address}`}
          href={checkoutInfoLink + "?change=email"}
          class="button-link-large"
        >
          {userRecurr.Button_change_text}
        </a>
      </div>
    </div>

    <div class="w-full h-px bg-primary-light"></div>

    <div
      role="listitem"
      aria-label={page.Aria_label_email_address_text}
      class="division-in-element-gap"
    >
      <div class="input-label text-black">
        {userRecurr.Label_shipping_method}
      </div>

      <div class="division-in-element-gap flex flex-wrap items-center">
        <div class="input-text-large-static grow">
          <DynamicHTML htmlFn={() => window.checkoutInfo.shipping_method} />
        </div>

        <a
          aria-label={`${userRecurr.Button_change_text} ${userRecurr.Label_shipping_method}`}
          href={checkoutShippingLink}
          class="button-link-large"
        >
          {userRecurr.Button_change_text}
        </a>
      </div>
    </div>
  </section>

  <section class="division-gap grid">
    <h2 class="recoleta text-h2 text-primary">{page.Block_title}</h2>

    <div role="list" class="division-in-element-gap flex flex-col">
      <div class="flex">
        <label role="listitem" class="division-in-element-gap radio-input">
          <input
            type="radio"
            name="billing_address"
            id="same-as-shipping"
            checked
          />

          <div class="radio-input-text">
            {page.Radio_button_text_same_as_shipping_address}
          </div>
        </label>
      </div>

      <div class="flex">
        <label role="listitem" class="division-in-element-gap radio-input">
          <input
            type="radio"
            name="billing_address"
            id="different-than-shipping"
          />

          <div class="text-b5 text-black-light flex">
            {page.Radio_button_text_use_different_billing_address}
          </div>
        </label>
      </div>
    </div>

    <div id="shipping-address" class="division-gap grid hidden">
      <!-- address tags goes here -->

      <div
        role="form"
        aria-label={page.text_shipping_address}
        class="form-grid"
      >
        <label>
          <span>{recurData.text_first_name}</span>

          <input
            type="text"
            name="billing_first_name"
            value=""
            placeholder={recurData.first_name_placeholder}
            required
          />
        </label>

        <label>
          <span>{recurData.text_last_name}</span>

          <input
            type="text"
            name="billing_last_name"
            placeholder={recurData.last_name_placeholder}
            required
          />
        </label>

        <label>
          <span>{recurData.text_street}</span>

          <input
            type="text"
            name="billing_street"
            placeholder={recurData.street_placeholder}
            required
          />
        </label>

        <label>
          <span>{recurData.text_city}</span>

          <input
            type="text"
            name="billing_city"
            placeholder={recurData.city_placeholder}
            required
          />
        </label>

        <label>
          <span>{recurData.text_postal_code}</span>

          <input
            type="number"
            name="billing_postal_code"
            placeholder={recurData.postal_code_placeholder}
            required
          />
        </label>

        <label>
          <span>{recurData.text_country}</span>

          <select id="country-select" name="billing_country" required>
            <option value="" selected disabled hidden>
              {recurData.country_placeholder}
            </option>

            {
              recurData.countries.data.map(
                ({ attributes: { name, localizations } }) => (
                  <option
                    value={localizations?.data[0]?.attributes?.name || name}
                  >
                    {name}
                  </option>
                ),
              )
            }
          </select>
        </label>
      </div>
    </div>
  </section>

  <section class="division-gap grid">
    <h2 class="recoleta text-h2 text-primary">{page.Block2_title}</h2>

    <div role="list" class="payment-card-container flex flex-wrap form-gap">
      {
        methods.map(({ method, icon, supported_countries }) => {
          const country = supported_countries.data.map(
            ({ attributes: { name } }) => name,
          );

          return (
            <div class:list={[country.length > 0 && "hidden"]}>
              <input
                type="radio"
                name="payment_method"
                id={method}
                value={method}
                data-country={country}
                class="payment-card-input-selector peer hidden"
              />

              <label for={method} class="radio-button-card">
                {async () => (
                  <img
                    class="payment-icon"
                    alt={icon.data?.attributes.alternativeText}
                    src={await localizeCMSImage(icon.data?.attributes.url)}
                  />
                )}

                <span>
                  {method?.charAt(0)?.toUpperCase() + method?.slice(1)}
                </span>
              </label>
            </div>
          );
        })
      }
    </div>

    <div data-name="card-info" class="payment-info division-gap grid !hidden">
      <div class="division-in-gap">
        <div class="text-b3 font-bold text-black">Card details</div>

        <div class="division-in-gap flex flex-wrap">
          <div class="text-b5 text-black-light">Accepted cards</div>

          <div class="division-in-element-gap flex flex-wrap items-center">
            {
              accepted_cards_icon?.map(
                ({ url, alternativeText }) =>
                  async () => (
                    <img
                      class="h-[20px] bg-white rounded"
                      alt={alternativeText}
                      src={await localizeCMSImage(url)}
                    />
                  ),
              )
            }
          </div>
        </div>
      </div>

      <div role="form" class="form-grid">
        <label>
          <span>{page.Card_label_name}</span>

          <input
            type="text"
            name="card_name"
            placeholder={page.Card_placeholder_name}
            required
          />
        </label>

        <label>
          <span>{page.Card_label_number}</span>

          <input
            type="number"
            name="card_number"
            placeholder={page.Card_placeholder_number}
            required
          />
        </label>

        <label>
          <span>{page.Card_label_date}</span>

          <input
            type="text"
            name="card_exp_date"
            placeholder={page.Card_placeholder_date}
            required
          />
        </label>

        <label>
          <span>{page.Card_label_cvv}</span>

          <input
            type="number"
            name="card_cvv"
            placeholder={page.Card_placeholder_cvv}
            required
          />
        </label>
      </div>
    </div>

    {
      isIdeal && (
        <div
          data-name="ideal-info"
          class="payment-info division-gap grid !hidden"
        >
          <div role="form" class="form-grid">
            <label>
              <span>{page.Ideal_label_select_bank}</span>

              <select id="ideal-bank-select" name="ideal_bank" required>
                <option value="" selected disabled hidden>
                  {page.Ideal_placeholder_select_bank}
                </option>

                {page.Ideal_bank_list.map(({ Bank_name, Value }) => (
                  <option value={Value}>{Bank_name}</option>
                ))}
              </select>
            </label>
          </div>
        </div>
      )
    }

    <div
      data-name="paypal-klarna-bancontact-sofort-info"
      class="payment-info division-gap grid !hidden"
    >
      <div role="form" class="form-grid">
        <label>
          <span>{page.Label_name}</span>

          <input
            type="text"
            name="payment_name"
            placeholder={page.Placeholder_name}
            required
          />
        </label>
      </div>
    </div>

    <div class="checkout-button-container">
      <a href={checkoutShippingLink} class="button-link-large">
        <span class="sm:hidden">
          {
            `${
              userRecurr.Button_return_to_text
            } ${shortenedSteps[1]?.toLowerCase()}`
          }
        </span>
        <span class="hidden sm:block">
          {`${userRecurr.Button_return_to_text} ${steps[1]?.toLowerCase()}`}
        </span>
      </a>

      <button
        id="submit-btn"
        type="submit"
        class="w-full sm:w-1/3 button-disabled-large"
        disabled
      >
        <span>
          {page.Button_text_pay_with}
          <span class="payment-type"></span>
        </span>
      </button>
    </div>
  </section>
</form>

<section class="hidden xl:block xl:w-1/3">
  <OrderSummary page={page} />
</section>

<script is:inline>
  const id = document.getElementById.bind(document),
    queryAll = document.querySelectorAll.bind(document),
    addClass = (element, className) => element.classList.add(className),
    removeClass = (element, className) => element.classList.remove(className),
    getInputValue = (parent, name) =>
      parent.querySelector(`input[name=${name}]`).value,
    addChangeListener = (element, functionName) =>
      element.addEventListener("change", functionName);

  const sameAsShipping = id("same-as-shipping"),
    differentThanShipping = id("different-than-shipping"),
    shippingAddress = id("shipping-address"),
    countrySelect = id("country-select"),
    paymentCardInputSelector = queryAll(".payment-card-input-selector"),
    paymentInfoElements = queryAll(".payment-info"),
    submitBtn = id("submit-btn"),
    submitBtnPaymentType = submitBtn.querySelector(".payment-type");

  const toggleDisabled = (elements, condition) =>
    elements.forEach((element) =>
      element[condition ? "setAttribute" : "removeAttribute"]("disabled", true),
    );

  const selectTextAndNumberInputs = (parent) =>
    parent.querySelectorAll("input[type='text'], input[type='number']");

  function toggleShippingAddress() {
    const isSameShipping = sameAsShipping.checked;

    isSameShipping
      ? addClass(shippingAddress, "hidden")
      : removeClass(shippingAddress, "hidden");
  }

  function hideAllPaymentInfo() {
    paymentInfoElements.forEach((paymentInfo) =>
      addClass(paymentInfo, "!hidden"),
    );

    submitBtnPaymentType.innerHTML = "";
    removeClass(submitBtn, "button-primary-large");
    addClass(submitBtn, "button-disabled-large");
    submitBtn.setAttribute("disabled", true);
  }

  function togglePaymentCardVisibility() {
    const selectedCountry = countrySelect.value.toLowerCase();

    paymentCardInputSelector.forEach((cardSelector) => {
      cardSelector.checked = false;
      const countryName = cardSelector
        ?.getAttribute("data-country")
        ?.toLowerCase();

      if (!countryName) return;

      countryName.includes(selectedCountry)
        ? removeClass(cardSelector.parentElement, "hidden")
        : addClass(cardSelector.parentElement, "hidden");
    });

    paymentInfoElements.forEach((paymentInfo) => {
      const paymentInfoInputs = selectTextAndNumberInputs(paymentInfo);

      paymentInfoInputs.forEach((input) => input.removeAttribute("required"));
    });
  }

  function handlePaymentCardInputChange(event) {
    if (!event.target.classList.contains("payment-card-input-selector")) return;

    const inputValue = event.target.value.toLowerCase();
    submitBtnPaymentType.innerHTML = ` ${inputValue}`;
    removeClass(submitBtn, "button-disabled-large");
    addClass(submitBtn, "button-primary-large");
    submitBtn.removeAttribute("disabled", true);

    paymentInfoElements.forEach((paymentInfo) => {
      const includesValue = paymentInfo
        .getAttribute("data-name")
        .toLowerCase()
        .includes(inputValue);

      toggleDisabled(selectTextAndNumberInputs(paymentInfo), !includesValue);

      includesValue
        ? removeClass(paymentInfo, "!hidden")
        : addClass(paymentInfo, "!hidden");

      const paymentInputName =
        includesValue && paymentInfo.querySelector("input[name*=name]");

      if (paymentInputName && paymentInputName.value !== null) {
        const fullName = `${getInputValue(
          shippingAddress,
          "billing_first_name",
        )} ${getInputValue(shippingAddress, "billing_last_name")}`;

        paymentInputName.setAttribute("value", fullName?.trim());
      }
    });
  }

  const contactInfo = JSON.parse(localStorage.getItem("checkout-info"));

  const setInputValue = (name, setValue) =>
    shippingAddress
      ?.querySelector(`input[name="${name}"]`)
      ?.setAttribute("value", setValue);

  const setBillingInfo = () => {
    const isSameShipping = sameAsShipping.checked;
    ["first_name", "last_name", "street", "city", "postal_code"].forEach(
      (field) =>
        setInputValue(
          `billing_${field}`,
          isSameShipping ? contactInfo[field] : "",
        ),
    );

    countrySelect.querySelectorAll("option").forEach((option) => {
      const isOptionSame =
        option.value.toLowerCase() === contactInfo.country.toLowerCase();

      isOptionSame &&
        option[isSameShipping ? "setAttribute" : "removeAttribute"](
          "selected",
          true,
        );
    });

    togglePaymentCardVisibility();
    hideAllPaymentInfo();
  };

  setBillingInfo();
  addChangeListener(sameAsShipping, () => {
    toggleShippingAddress();
    setBillingInfo();
  });
  addChangeListener(differentThanShipping, () => {
    toggleShippingAddress();
    setBillingInfo();
  });
  addChangeListener(countrySelect, () => {
    togglePaymentCardVisibility();
    hideAllPaymentInfo();
  });
  document.addEventListener("change", handlePaymentCardInputChange);
</script>
