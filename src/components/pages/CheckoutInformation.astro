---
import CMS from "@store/CMS";
import getLocalizedLink from "@utils/getLocalizedLink";

import Markdown from "@components/Markdown.astro";
import OrderSummary from "@components/OrderSummary.astro";

import CheckoutInformationForm from "@solid/CheckoutInformationForm.astro";

const { page, recurData } = Astro.props,
  { locale } = page,
  checkoutCartLink = CMS.get("cart", locale).Meta.URL_slug,
  checkoutShippingLink = CMS.get("checkoutShipping", locale).Meta.URL_slug,
  userAccountRecurData = CMS.get("userAccountRecurringElement", locale);
---

<style lang="scss">
  @use "src/styles/checkout" as *;
</style>

<section class="w-full xl:w-2/3">
  <form
    role="main"
    aria-label={page.Aria_label_form_text}
    id="checkout-info-form"
    class="section-gap flex flex-col"
    action={getLocalizedLink(locale, checkoutShippingLink)}
  >
    <div
      role="form"
      aria-label={page.text_contact_info}
      class="division-gap grid"
    >
      <h2 class="recoleta text-h2 text-primary">{page.text_customer}</h2>

      <div
        id="guest-intro-text"
        class="prose-text prose max-w-none text-b5 text-black-light"
      >
        <Markdown>{page.Guest_intro_text}</Markdown>
      </div>

      <div class="form-grid">
        <label>
          <span class="input-label">{recurData.text_email_address}</span>

          <input
            type="email"
            name="email"
            placeholder={recurData.email_address_placeholder}
            required
          />
        </label>
      </div>

      <div
        id="sign-in-text"
        class="prose-text prose max-w-none text-b5 text-black-light"
      >
        <Markdown>{page.Sign_in_text}</Markdown>
      </div>
    </div>

    <script is:inline>
      const guestIntroText = document.getElementById("guest-intro-text"),
        signInText = document.getElementById("sign-in-text");

      if (window.cookies.isAuthenticated === "true") {
        guestIntroText.remove();
        signInText.remove();
      }
    </script>

    <div
      role="form"
      aria-label={page.text_shipping_address}
      id="shipping-address"
      class="division-gap grid"
    >
      <h2 class="recoleta text-h2 text-primary">
        {page.text_shipping_address}
      </h2>

      <CheckoutInformationForm
        {recurData}
        {userAccountRecurData}
        text_select_or_create_tag={page.text_select_or_create_tag}
      />
    </div>

    <div class="block lg:hidden">
      <OrderSummary page={page} />
    </div>

    <div class="checkout-button-container">
      <a href={checkoutCartLink} class="button-link-large">
        {page.text_return_to_cart}
      </a>

      <button class="w-full sm:w-1/3 button-primary-large">
        {page.text_continue_to_shipping}
      </button>
    </div>
  </form>
</section>

<section class="hidden xl:block xl:w-1/3">
  <OrderSummary page={page} />
</section>

<script>
  const change = new URLSearchParams(location.search).get("change");

  if (["email", "address"].includes(change)) {
    const elementToScrollTo = document.querySelector(
      change === "email" ? "input[name=email]" : "#shipping-address",
    ) as HTMLElement;

    elementToScrollTo.scrollIntoView({
      block: change === "email" ? "center" : "start",
    });

    elementToScrollTo.focus();
  }
</script>
