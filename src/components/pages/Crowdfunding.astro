---
import CupIcon from "@images/cup.svg";
import FlowerIcon from "@images/flower.svg";
import LoveGreenIcon from "@images/loveGreen.svg";
import Sec3BG from "@images/willian-justen-de-vasconcellos-_MMP5j_fCqw-unsplash_flop.webp";

import Markdown from "@astrojs/markdown-component";

import PlanCards from "@components/PlanCards.astro";
import ClippedImg from "@components/ClippedImg.astro";
import ClipPathSVG from "@components/ClipPathSVG.astro";
import HeroBackground from "@components/HeroBackground.astro";
import CrowdfundingProgress from "@components/CrowdfundingProgress.astro";

import UpdateHeroTopMargin from "@scripts/UpdateHeroTopMargin.astro";

const url = `${import.meta.env.CloudImg_URL}`;
const { page } = Astro.props;

const { supportersCount, totalAmountRaised } = await fetch(
  "https://crowdfunding-stats.scripts.dilmahtea.me"
).then((res) => res.json());

const goal = 100000,
  progress = totalAmountRaised / goal;

const initialProgress = `0%`,
  finalProgress = `${progress * 100}%`,
  animationDuration = 1000;
---

<style lang="scss">
  @use "src/styles/colors";

  .crowdHomeInfoTxt,
  .crowdHomeInfoTxt a {
    color: colors.$light-gray;
  }
</style>

{/* Hero Section */}
<div class="hero overflow-hidden relative">
  <UpdateHeroTopMargin />

  <HeroBackground />

  {/* Text Content */}
  <div class="relative h-full wrapper z-30 HeroTxtContainer">
    <div class="sm:w-1/2 lg:w-7/12 HeroTxtContent" role="banner">
      <div class="flex flex-wrap">
        <h1 class="heroTitle">
          {page.Title}
          <span class="icon relative top-0">
            <span class="relative heading-inline-icon">
              <img class="w-full h-full" src={CupIcon} alt="cup-icon" />
            </span>
          </span>
        </h1>
        <div class="prose max-w-none heroTxt">
          <Markdown>{page.Intro_text}</Markdown>
        </div>
        <a href={page.Heading_button_link}>
          <div
            class="flex items-center justify-center font-bold text-center heroBtn"
          >
            <span class="icon relative top-0">
              <span class="relative heroBtnIcon">
                <img class="w-full h-full" src={LoveGreenIcon} alt="cup-icon" />
              </span>
            </span>
            {page.Heading_button_text}
          </div>
        </a>
      </div>
    </div>
  </div>

  {/* Blob Image - Desktop View */}
  <div class="hidden sm:block absolute z-20 h-full heroCurve2Container">
    <ClipPathSVG
      id="hero-curve-2"
      path="M1 0H.052C-.055.156.033.342.049.606.065.888.178 1 .555 1 .843 1 .918.906 1 .854"
    />

    <div class="w-full h-full relative" style="clip-path: url(#hero-curve-2);">
      <img
        src={url +
          page.Intro_blob.data.attributes.provider_metadata.public_id +
          `/cms`}
        style="height: 100%; width: 100%; position: relative; right: 50px; object-fit: cover;"
      />

      <div class="absolute bottom-0 w-full progressContainer">
        <div
          class="inset-0 w-auto flex justify-center mx-auto progressContentContainer"
        >
          <div
            class="w-full h-full absolute top-0 left-0 progressContentContainerBackground"
          >
          </div>

          <CrowdfundingProgress
            goalText={page.Heading_goal}
            supportersText={page.Heading_supporters}
            {supportersCount}
            {totalAmountRaised}
          />
        </div>
      </div>
    </div>
  </div>
</div>

{/* Blob Image - Mobile View */}
<div class="block sm:hidden relative -mt-20 z-20 w-full">
  <div class="heroCurve3Container relative">
    <ClippedImg
      id="hero-curve-3"
      src={url +
        page.Intro_blob.data.attributes.provider_metadata.public_id +
        `/small`}
      path="M1 .074v.904S.906 1 .774 1C.706 1 .637.996.569.993.487.989.405.984.324.986a4.576 4.576 0 0 0-.117.005C.115.996.032 1.001 0 .986V.074C.062.024.147 0 .282 0c.075 0 .165.023.244.043.062.016.118.03.154.03.026 0 .06-.007.097-.014C.861.044.959.025 1 .074"
    />

    <div class="absolute bottom-0 w-full progressContainer">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        viewBox="0 0 375 130.6"
        class="relative z-40 bottom-0"
      >
        <path
          d="M0 0h375v124.1s-35.1 6.5-84.6 6.5c-25.5 0-51.2-1.1-76.9-2.1-30.8-1.3-61.6-2.6-92-2.1-14.4.3-29.5 1-44 1.6-34.4 1.5-65.7 2.9-77.5-1.6Z"
          fill-opacity=".75"
          fill-rule="evenodd"></path>
      </svg>

      <div
        class="absolute inset-0 z-50 w-auto flex justify-center mx-auto wrapper"
      >
        <CrowdfundingProgress
          goalText={page.Heading_goal}
          supportersText={page.Heading_supporters}
          {supportersCount}
          {totalAmountRaised}
        />
      </div>
    </div>
  </div>
</div>

<script
  defer
  define:vars={{ initialProgress, finalProgress, animationDuration }}
>
  const progressBars = document.querySelectorAll(".progress");

  progressBars.forEach((progressBar) => {
    progressBar.animate(
      { width: [initialProgress, finalProgress] },
      animationDuration
    ).onfinish = () => {
      progressBar.style.width = finalProgress;
    };
  });
</script>

{/* Plans Section */}
<div class="wrapper planSec" role="main">
  <h2 class="heading-primary text-primary" id="plans">
    {page.Heading_plans}
  </h2>
  <PlanCards allPlans={page.allPlans} />
</div>

{/* Info Section */}
<div class="crowdHomeInfo overflow-hidden relative">
  {/* Background  */}
  <div class="absolute z-10 -top-10 sm:top-0 -left-0.5 w-screen h-full">
    <ClippedImg
      id="crowdHomeInfoImgFrame"
      src={Sec3BG}
      path="M1,0.055 S0.962,-0.005,0.847,0 C0.729,0.006,0.602,0.049,0.484,0.044 C0.381,0.04,0.239,0.018,0.136,0.028 C0.073,0.034,0,0.055,0,0.055 V0.965 s0.032,0.035,0.156,0.035 c0.061,0,0.136,-0.012,0.193,-0.027 c0.06,-0.016,0.161,-0.017,0.231,-0.017 c0.074,0,0.2,0.037,0.315,0.01 s0.106,-0.071,0.106,-0.071 V0.055"
    />
  </div>

  {/* Blob Image - Desktop View */}
  <div
    class="hidden sm:block absolute left-0 z-20 w-full sm:w-1/2 h-full items-center crowdHomeInfo_Curve1"
  >
    <ClippedImg
      id="crowdHomeInfo_ImgFrame1"
      src={url +
        page.Block_blob.data.attributes.provider_metadata.public_id +
        `/cms`}
      className="relative"
      style="left: -20px; object-fit: cover;"
      path="M1 .494V.507A.019.028 0 0 0 1 .51v.016A.024.035 0 0 0 1 .53L.998.579C.991.693.986.856.835.945a.362.362 0 0 1-.222.05C.567.992.521.984.473.981L.438.98C.357.98.275 1 .204 1A.19.19 0 0 1 .079.961C-.011.886.018.658.018.485.018.396.005.337.001.277A.191.28 0 0 1 0 .244C0 .206.004.166.018.115.041.025.106.004.189.003c.071 0 .155.015.238.015L.45.017C.494.014.551.006.612.002.708-.004.816.001.893.063.976.13.997.311 1 .449v.025"
    />
  </div>

  {/* Text Content */}
  <div class="relative h-full wrapper z-30" role="complementary">
    <div class="w-full h-full justify-end flex flex-wrap">
      <div
        class="w-full sm:w-1/2 h-full flex sm:items-center crowdHomeInfoContent"
      >
        <div class="relative">
          <h2 class="heading-primary crowdHomeInfoHeader">
            {page.Heading_block}
            <span class="icon relative top-2">
              <span class="relative heading-inline-icon">
                <img class="w-full h-full" src={FlowerIcon} alt="flower-icon" />
              </span>
            </span>
          </h2>
          <div class="pt-0.5 mt-7 sm:mt-12 prose max-w-none crowdHomeInfoTxt">
            <Markdown>{page.Block_text}</Markdown>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{/* Blob Image - Mobile View */}
<div class="block sm:hidden relative -mt-28 z-20 w-full">
  <div class="w-screen">
    <ClippedImg
      id="crowdHomeInfoImgFrame2"
      src={url +
        page.Block_blob.data.attributes.provider_metadata.public_id +
        `/small`}
      path="M.282 0C.147 0 .062.021 0 .064V.97c.045.046.195.006.324 0C.473.963.625 1 .774 1A.561.561 0 0 0 1 .954v-.89c-.059-.061-.237 0-.32 0S.417 0 .282 0"
    />
  </div>
</div>

<div class="h-8"></div>
