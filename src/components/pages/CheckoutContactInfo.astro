---
import CMS from "@store/CMS";

const { page, recurData } = Astro.props;

const { locale } = page,
  { data: checkoutShippingData } = CMS.get("checkoutShipping"),
  { URL_slug: shippingPageSlug } = checkoutShippingData.attributes.Meta,
  shippingPageLink = "/" + locale + "/" + shippingPageSlug;
---

<style lang="scss">
  @use "src/styles/poly-fluid" as *;

  form {
    padding: poly-fluid-clamp(
      (
        375px: 25px 25px,
        1440px: 32px 56px,
      )
    );
  }

  .form-grid-container {
    @apply flex flex-col;

    gap: poly-fluid-clamp(
      (
        375px: 10px,
        1440px: 35px,
      )
    );

    .form-grid {
      @apply w-full grid gap-y-2.5;

      @media (min-width: 480px) {
        @apply grid-cols-2;

        gap: poly-fluid-clamp(
          (
            480px: 10px 40px,
            1440px: 25px 100px,
          )
        );
      }

      label {
        @apply flex flex-col gap-1.5;

        span {
          @apply font-medium text-dark sm:text-[1.125rem];
        }

        input,
        select {
          @apply focus:ring focus:ring-emerald-800 focus:ring-opacity-20 focus:outline-none;
          @apply h-12 bg-lightgray py-3 px-4 border border-primary rounded-full text-dark sm:text-[1.125rem];
        }
      }
    }
  }
</style>

<form class="flex flex-col gap-12" action={shippingPageLink}>
  <div class="form-grid-container">
    <h4 class="alice">Contact info</h4>

    <div class="form-grid">
      <label>
        <span>Email Address</span>

        <input
          type="text"
          id="email"
          name="email"
          placeholder="Enter your email address"
          required
        />
      </label>
    </div>
  </div>

  <div class="form-grid-container">
    <h4 class="alice">Shipping Address</h4>

    <div class="form-grid">
      <label>
        <span>First Name</span>

        <input
          type="text"
          id="first_name"
          name="first_name"
          placeholder="Enter your first name"
          required
        />
      </label>

      <label>
        <span>Last Name</span>

        <input
          type="text"
          id="last_name"
          name="last_name"
          placeholder="Enter your last name"
          required
        />
      </label>

      <label>
        <span>Country</span>

        <select id="country" name="country" required>
          <option value="" selected disabled hidden>Select your country</option>
          <option value="nl-Nederland">Nederland</option>
          <option value="en-England">England</option>
          <option value="de-Germany">Germany</option>
        </select>
      </label>

      <label>
        <span>City</span>

        <input
          type="text"
          id="city"
          name="city"
          placeholder="Enter your city"
          required
        />
      </label>

      <label>
        <span>Street</span>

        <input
          type="text"
          id="address"
          name="address"
          placeholder="Enter your street address"
          required
        />
      </label>

      <label>
        <span>Postal Code</span>

        <input
          type="text"
          id="postal_code"
          name="postal_code"
          placeholder="Enter your postal code"
          required
        />
      </label>
    </div>
  </div>

  <div
    class="flex flex-col sm:flex-row items-center justify-center sm:justify-start gap-9 sm:gap-12"
  >
    <button
      class="w-full sm:w-auto py-4 px-20 sm:px-24 bg-primary text-lightgray font-bold rounded-full"
    >
      Continue To Shipping
    </button>

    <button id="return-to-cart-btn" class="text-primary font-bold">
      Return To Cart
    </button>
  </div>
</form>

<script>
  import fillUpForm from "@utils/fillUpForm";

  declare global {
    interface Window {
      openCart: () => void;
      contactInfo: Record<string, FormDataEntryValue>;
    }
  }

  const savedCheckoutContactInfo = localStorage.getItem(
    "checkout-contact-info"
  );

  if (savedCheckoutContactInfo) {
    const parsedContactInfo = JSON.parse(savedCheckoutContactInfo);

    fillUpForm(Object.entries(parsedContactInfo));
  }

  const returnToCartBtn = document.getElementById("return-to-cart-btn"),
    checkoutContactInfoForm = document.querySelector(
      "#checkout-main form"
    ) as HTMLFormElement;

  checkoutContactInfoForm.addEventListener("submit", (event) => {
    event.preventDefault();

    const formData = Object.fromEntries(new FormData(checkoutContactInfoForm));

    localStorage.setItem("checkout-contact-info", JSON.stringify(formData));

    location.href = checkoutContactInfoForm.action;
  });

  returnToCartBtn.addEventListener("click", (event) => {
    event.preventDefault();

    window.openCart();
  });
</script>
