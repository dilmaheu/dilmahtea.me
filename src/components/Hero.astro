---
import CMS from "@store/CMS";
import { Picture } from "astro-imagetools/components";
import RecurringImages from "@store/RecurringImages";
import ClipPathSVG from "@components/ClipPathSVG.astro";
import UpdateTopMargin from "@scripts/UpdateTopMargin.astro";

const { hero_background, hero_background_sm } = RecurringImages;

const { page, locale, headerBackground } = Astro.props,
  { ASSETS_URL } = import.meta.env;

const recurData = CMS.get("recurringElement", locale),
  { Nav_menu: menu } = recurData;

const headerBackgroundImg = page?.Intro_blob?.data?.attributes.url,
  headerBackgroundImgSm = page?.Intro_blob_sm?.data?.attributes.url,
  headerBackgroundVideo = page?.Intro_video?.data?.attributes.url,
  headerBackgroundVideoSm = page?.Intro_video_sm?.data?.attributes.url;
---

<style lang="scss">
  @use "src/styles/poly-fluid" as *;

  .hero {
    @include poly-fluid-sizing(
      "padding-top",
      (
        639.98px: 135px,
        640px: 70px,
        768px: 74px,
        1024px: 104px,
      )
    );
  }

  .hero-background {
    aspect-ratio: 16 / 9;

    @media (min-width: 640px) {
      aspect-ratio: 3 / 1;
    }

    // @media (min-width: 400px) {
    //   aspect-ratio: 5 / 4;
    // }

    // @media (min-width: 549px) {
    //   aspect-ratio: 7 / 3;
    // }

    // @media (min-width: 700px) {
    //   aspect-ratio: 3 / 1;
    // }
  }

  .nav-menu-caontainer {
    nav {
      @include poly-fluid-sizing(
        "padding-right",
        (
          639px: 0px,
          640px: 260px,
          768px: 300px,
          1024px: 380px,
          1440px: 460px,
          1536px: 550px,
        )
      );

      a {
        @apply font-bold leading-[150%];

        font-size: poly-fluid-clamp(
          (
            768px: 12px,
            1440px: 18px,
          )
        );
      }
    }
  }

  // .header-background-video {
  //   @apply hidden;

  //   @media (min-width: 550px) {
  //     @apply block;
  //   }
  // }

  // .header-background-video-sm {
  //   @apply block;

  //   @media (min-width: 550px) {
  //     @apply hidden;
  //   }
  // }
</style>

<ClipPathSVG
  id="hero-background-curve"
  path="M1 0v.939A.27.27 0 0 1 .828 1H.81A1.462 1.462 0 0 1 .648.987C.586.981.522.974.451.974.376.974.312.981.252.988.202.994.156 1 .11 1H.097C.009.996 0 .956 0 .956V0"
/>

<section
  class:list={[
    "hero relative overflow-hidden h-full bg-primary",
    headerBackground ? "pb-0" : "pb-9 sm:pb-0",
  ]}
  style="clip-path: url(#hero-background-curve);"
>
  <UpdateTopMargin />

  {
    (headerBackground || hero_background) &&
      (headerBackgroundVideo ? (
        async () => {
          const poster = await importRemoteImage(
              ASSETS_URL + headerBackgroundImg + "?w=1920"
            ),
            posterSm = await importRemoteImage(
              ASSETS_URL +
                (headerBackgroundImgSm || headerBackgroundImg) +
                "?w=550"
            );

          return (
            <>
              <video
                class="header-background-video object-cover h-full w-full absolute inset-0"
                src={ASSETS_URL + headerBackgroundVideo}
                poster={poster}
                autoplay
                preload="metadata"
                muted
                loop
              />
              {/*<video
                class="header-background-video-sm object-cover h-full w-full absolute inset-0"
                src={
                  ASSETS_URL +
                  (headerBackgroundVideoSm || headerBackgroundVideo)
                }
                poster={posterSm}
                autoplay
                preload="metadata"
                muted
                loop
              />*/}
            </>
          );
        }
      ) : (
        <Picture
          alt=""
          layout="fill"
          preload="avif"
          objectFit="cover"
          objectPosition="left top"
          src={
            ASSETS_URL +
            (headerBackground
              ? headerBackgroundImgSm || headerBackgroundImg
              : hero_background_sm?.src || hero_background.src)
          }
          breakpoints={{
            maxWidth: headerBackground ? 550 : 768,
          }}
          artDirectives={[
            {
              media: `(min-width: ${headerBackground ? "550px" : "768px"})`,
              src: headerBackground
                ? ASSETS_URL + headerBackgroundImg
                : hero_background.src,
              breakpoints: {
                minWidth: headerBackground ? 550 : 768,
              },
            },
          ]}
          attributes={{
            picture: {
              style: "position: absolute;",
            },
          }}
        />
      ))
  }

  {
    headerBackground && (
      <div
        class:list={[
          "absolute inset-0 w-full h-full bg-gradient-to-b",
          "sm:bg-gradient-to-r from-black/50 via-black/40 md:via-black/20",
        ]}
      />
    )
  }

  <div class:list={["relative h-full", headerBackground && "hero-background"]}>
    <div class="hidden md:flex items-end bg-primary-light md:h-[76px]">
      <div class="nav-menu-caontainer wrapper pb-2.5 md:pb-[15px]">
        <nav class="text-black font-semibold h-full">
          <span class="flex gap-5 justify-between items-center h-full">
            {
              menu.map(
                ({ Visibility, Title, Link }) =>
                  Visibility && <a href={Link}>{Title}</a>
              )
            }
          </span>
        </nav>
      </div>
    </div>

    <slot />
  </div>
</section>
