<script is:inline>
  {
    window.replacePlaceholders = (content, data) => {
      const placeholderRegex =
        /<placeholder\s+name=(?:"|&#34;)(\w+)(?:"|&#34;)[^>]*><\/placeholder>/g;

      return content.replace(
        placeholderRegex,
        (match, placeholderName) => data[placeholderName]
      );
    };

    window.checkoutInfo = JSON.parse(
      localStorage.getItem("checkout-info") || "{}"
    );

    const storedCart = JSON.parse(localStorage.getItem("cart") || "{}");

    let subTotal, tax, shippingCost, total;

    const updateAmounts = (cart) => {
      [subTotal = 0, tax = 0] = Object.values(cart).reduce(
        ([priceSum, taxSum], { price, tax }) => [
          priceSum + Number(price),
          taxSum + Number(tax),
        ],
        [0, 0]
      );

      shippingCost = Number(window.checkoutInfo?.shipping_cost) || 0;

      total = subTotal + shippingCost;

      subTotal = subTotal.toFixed(2).replace(".", ",");
      tax = tax.toFixed(2).replace(".", ",");
      shippingCost = shippingCost?.toFixed(2)?.replace(".", ",");
      total = total?.toFixed(2)?.replace(".", ",");
    };

    updateAmounts(storedCart);

    const id = document.getElementById.bind(document),
      queryAll = document.querySelectorAll.bind(document);

    let cartSize, cartSubTotal, orderTotal, orderShippingCost;

    const updateUI = (cart) => {
      cartSize ??= id("cart-size");
      cartSubTotal ??= id("cart-subtotal");

      orderTotal ??= queryAll(".order-total");
      orderShippingCost ??= queryAll(".order-shipping-cost");

      updateAmounts(cart);

      cartSubTotal && (cartSubTotal.textContent = "€" + subTotal);
      cartSize && (cartSize.textContent = Object.values(cart).length);

      orderTotal.forEach((span) => (span.textContent = "€" + total));
      orderShippingCost.forEach(
        (span) => (span.textContent = "€" + shippingCost)
      );
    };

    window.cart = new Proxy(storedCart, {
      get(cart, property) {
        switch (property) {
          case "subTotal":
            return subTotal;

          case "tax":
            return tax;

          case "shippingCost":
            return shippingCost;

          case "total":
            return total;

          case "updateUI":
            return updateUI;

          default:
            return cart[property];
        }
      },

      set(cart, id, productData) {
        cart[id] = productData;

        localStorage.setItem("cart", JSON.stringify(cart));

        updateUI(cart);

        return true;
      },

      deleteProperty(cart, property) {
        delete cart[property];

        localStorage.setItem("cart", JSON.stringify(cart));

        updateUI(cart);

        return true;
      },
    });
  }
</script>
