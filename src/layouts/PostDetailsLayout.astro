---
import { parseHTML } from "linkedom";

import Chapters from "@components/Chapters.astro";
import HeroContent from "@components/HeroContent.astro";
import ClipPathSVG from "@components/ClipPathSVG.astro";
import HeadingLinks from "@components/HeadingLinks.astro";
import RelevantPosts from "@components/RelevantPosts.astro";
import ChaptersFunctionality from "@components/scripts/ChaptersFunctionality.astro";

import RecurringImages from "@store/RecurringImages";

const { green_book } = RecurringImages;

const {
  page,
  posts,
  recurData,
  ariaLabelRecurData,
  headingName,
  plainTitle,
  type,
  headerBackground,
  headerBackgroundSm,
} = Astro.props;

const relatedPosts =
  page?.related_products?.data?.map(({ attributes }) => attributes) ||
  page?.blogs?.data?.map(({ attributes }) => attributes) ||
  page?.Relevant_recipes?.data?.map(({ attributes }) => attributes) ||
  page?.Relevant_blogs?.data?.map(({ attributes }) => attributes) ||
  posts?.filter(({ Meta }) => Meta.URL_slug !== page.Meta.URL_slug);

const relatedPostsHeading =
  page.Relevant_items_title ||
  (page.Relevant_recipes && recurData.recipe_discover) ||
  recurData.text_explore_the_world_of_kindness;

const relatedPostsText = page.Relevant_items_text;

const contentHTML = await Astro.slots.render("post-details"),
  { document: contentDocument } = parseHTML(contentHTML),
  headings = contentDocument.querySelectorAll("h2");
---

<style lang="scss">
  @use "src/styles/colors";

  #sticky-chapters {
    box-shadow: 0 4px 5px gray;
  }

  #sticky-chapter-links {
    border-color: colors.$primary-light;
  }

  #reading-progress-bar {
    border-top-right-radius: 0.127rem;
    border-bottom-right-radius: 0.157rem;
  }

  #headings-header {
    font-size: clamp(1.5rem, 2.2vw + 0.15rem, 2rem);
  }

  #chapter-links {
    font-size: clamp(1rem, 1.2vw + 0.2rem, 1.5rem);
  }
</style>

<ClipPathSVG
  id="content-images-curve"
  path="M.516.008C.36.008.1-.008.04.082S.002.495.017.736.182 1 .528 1C.813 1 .902.936.974.717 1.005.624 1.021.395.945.128.897-.045.734.008.516.008"
/>

{/* Hero Section */}
<HeroContent {page} {plainTitle} {headerBackground} {headerBackgroundSm}>
  {/* Recipe Header */}
  <slot name="recipe-header" />

  {/* tea-details header section */}
  <slot name="tea-details-header" />

  {/* tea variants header section */}
  <slot name="tea-variants-header" />
</HeroContent>

{/* howto header section */}
<slot name="howto-header" />

{/* product page sections */}
<slot name="product-page-sections" />

{/* Blog Section */}
<section
  class="py-[50px]"
  role={type || "main"}
  aria-label={ariaLabelRecurData.Post_details_text}
>
  <div
    id="sticky-chapters"
    class="pt-1.5 self-start invisible md:hidden w-full sticky top-0 z-[998] bg-secondary text-black overflow-hidden"
  >
    <div class="wrapper relative select-none">
      <div
        id="sticky-dropdown-toggle"
        class:list={[
          "py-[15px] font-bold cursor-pointer focus:outline-none",
          "flex items-center justify-between gap-x-1.5 md:gap-x-3",
        ]}
      >
        <div class="flex items-center">
          <div class="w-7 h-full mr-[13px]">
            <img class="w-full h-full" {...green_book} />
          </div>

          <div id="sticky-chapters-heading" class="font-medium">
            {headingName}
          </div>
        </div>

        <svg
          class="w-3 text-black-light"
          viewBox="0 0 11.6 6.7"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            d="M.3.3A.6.6 0 0 1 .9 0a.9.9 0 0 1 .6.3l4.3 4.3L10.2.3a.6.6 0 0 1 .6-.3l.6.3a.8.8 0 0 1 .2.6.7.7 0 0 1-.2.6l-5 4.9a.6.6 0 0 1-.6.3.9.9 0 0 1-.6-.3L.3 1.5A.9.9 0 0 1 0 .9.6.6 0 0 1 .3.3Z"
            fill="#2B4B50"></path>
        </svg>
      </div>

      {
        headings.length > 0 && (
          <div
            id="sticky-headings"
            class:list={[
              "hidden flex flex-col max-h-[70vh]",
              "pt-[15px] pb-[25px] border-t border-primary-light overflow-y-auto",
            ]}
          >
            <div
              role="list"
              id="sticky-chapter-links"
              class="grid overflow-y-auto"
            >
              <HeadingLinks type="mobile" headings={headings}>
                {/* html source to extract heading links from */}
                <slot name="post-details" />
              </HeadingLinks>
            </div>

            {/* Jump to Recipe Small Button */}
            <slot name="jump-to-recipe-sm" />

            {/* Cart Adding Form (Sm) */}
            <slot name="cart-adding-form-sm" />
          </div>
        )
      }
    </div>

    <div id="reading-progress-bar" class="py-[2.5px] bg-primary duration-150">
    </div>
  </div>

  <div class="wrapper w-full flex flex-col-reverse md:flex-row justify-between gap-[50px]">

    <div id="post-details" class="md:w-2/3 2xl:w-1/2 min-w-[400px]">
      <div class="prose-text xl:w-5/6 2xl:w-full">
        {/* post content */}
        <slot name="post-details" />
      </div>
    </div>

    {
      headings.length > 0 && (
        <Chapters 
          headingName={headingName}
          headings={headings}
        >
          {/* Jump to Recipe Button */}
          <slot name="jump-to-recipe" slot="top-slot" />
          
          {/* Cart Adding Form (Sm) */}
          <slot name="cart-adding-form-sm" />

          {/* Cart Adding Form Fixed (Sm) */}
          <slot name="cart-adding-form-fixed-sm" />
        </Chapters>
      )
    }
  </div>
</section>

{/* product infos */}
<slot name="product-info" />

{/* estate map */}
<slot name="estate-map" />

{/* product kindness impact  */}
<slot name="product-kindness-impact" />

{/* Relevant Posts Section */}
<RelevantPosts
  {page}
  posts={relatedPosts}
  text={relatedPostsText}
  heading={relatedPostsHeading}
/>

{headings.length > 0 && <ChaptersFunctionality />}

<slot name="wake-lock-script" />
