---
import CMS from "@store/CMS";
import BaseLayout from "@layouts/BaseLayout.astro";
import RecurringImages from "@store/RecurringImages";
import { Picture } from "astro-imagetools/components";
import ClipPathSVG from "@components/ClipPathSVG.astro";

const { logo, checkout_header_background, checkout_header_background_sm } =
  RecurringImages;

interface Props {
  page: Record<string, any>;
  meta: Record<string, any>;
  locale: string;
  recurData: Record<string, any>;
  metaImageSrc: string;
  availableLocales: string[];
}

const { page, meta, locale, availableLocales, metaImageSrc } =
  Astro.props as Props;

const checkoutStepOrder = page.checkout_step_order,
  checkoutFlowData = CMS.get("checkoutFlow").data.attributes,
  steps = checkoutFlowData.steps.split("\n"),
  shortenedSteps = checkoutFlowData.shortened_steps.split("\n");
---

<style lang="scss">
  @use "src/styles/poly-fluid" as *;

  .checkout-flow-container {
    padding: poly-fluid-clamp(
      (
        375px: 24px 24px,
        1440px: 40px 56px,
      )
    );

    > div {
      height: poly-fluid-clamp(
        (
          375px: 38px,
          1440px: 50px,
        )
      );
    }
  }

  .flow {
    > div {
      @apply h-full text-center flex flex-col justify-between items-center;

      span,
      h1 {
        @apply font-medium;

        font-size: poly-fluid-clamp(
          (
            375px: 10px,
            1440px: 16px,
          )
        );
      }

      div {
        @apply w-full rounded-full;

        height: poly-fluid-clamp(
          (
            375px: 5px,
            1440px: 8px,
          )
        );
      }
    }
  }
</style>

<BaseLayout
  page={page}
  meta={meta}
  locale={locale}
  availableLocales={availableLocales}
  metaImageSrc={metaImageSrc}
>
  <script is:inline>
    if (Object.keys(window.cart).length === 0) {
      history.back();
    }
  </script>

  <div id="checkout" class="bg-lightgray">
    <header class="checkout-flow-container z-10 fixed md:relative w-full">
      <ClipPathSVG
        id="checkout-header-curve"
        path="M0,0 L0,0.936 C0,0.936,0.009,1,0.107,1 C0.152,1,0.198,0.992,0.247,0.983 C0.305,0.973,0.368,0.961,0.441,0.961 C0.511,0.961,0.573,0.971,0.634,0.981 C0.692,0.991,0.749,1,0.81,1 C0.934,1,1,0.878,1,0.878 V0 H0"
      />

      <Picture
        alt=""
        layout="fill"
        preload="avif"
        breakpoints={{ maxWidth: 640 }}
        src={checkout_header_background_sm.src}
        artDirectives={[
          {
            media: "(min-width: 640px)",
            breakpoints: { minWidth: 640 },
            src: checkout_header_background.src,
          },
        ]}
        attributes={{
          picture: {
            style:
              "position: absolute; top: 0; left: 0; clip-path: url(#checkout-header-curve);",
          },
        }}
      />

      <div class="relative flex justify-between gap-[5%]">
        <a href="/" class="h-full">
          <img {...logo} class="h-full" />
        </a>

        <div
          class="flow flex-grow grid gap-[3.25%]"
          style={`grid-template-columns: ${Array.from({ length: steps.length })
            .map(() => "1fr")
            .join(" ")}`}
        >
          {
            steps.map((step, i) => {
              const shortenedStep = shortenedSteps[i],
                StepTitleTag = i + 1 === checkoutStepOrder ? "h1" : "span";

              return (
                <div>
                  <StepTitleTag
                    class:list={shortenedStep !== step && "hidden sm:inline"}
                  >
                    {step}
                  </StepTitleTag>

                  {shortenedStep !== step && (
                    <StepTitleTag class="inline sm:hidden">
                      {shortenedStep}
                    </StepTitleTag>
                  )}

                  {i + 1 === checkoutStepOrder ? (
                    <div class="grid grid-cols-2 bg-lightgray2/30">
                      <div class="bg-lightgray2" />
                    </div>
                  ) : i + 1 > checkoutStepOrder ? (
                    <div class="bg-lightgray2/30" />
                  ) : (
                    <div class="bg-lightgray2" />
                  )}
                </div>
              );
            })
          }
        </div>
      </div>
    </header>

    <ClipPathSVG
      id="product-image-curve"
      path="M0.516,0.008 C0.36,0.008,0.1,-0.008,0.04,0.082 C-0.021,0.172,0.002,0.495,0.017,0.736 C0.032,0.978,0.182,1,0.528,1 C0.813,1,0.902,0.936,0.974,0.717 C1,0.624,1,0.395,0.946,0.128 C0.897,-0.045,0.735,0.008,0.516,0.008"
    />

    <main
      id="checkout-main"
      class="flex mt-[clamp(86px,18vw+2px,100px)] md:mt-0"
    >
      <slot />
    </main>
  </div>
</BaseLayout>
